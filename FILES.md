# üìÑ Module 5 - QR Code & PDF

Ce document explique le syst√®me de g√©n√©ration de QR codes et de PDF impl√©ment√© dans le backend Restaurant SaaS.

## ‚úÖ Fonctionnalit√©s Impl√©ment√©es

### üì± **G√©n√©ration QR Codes**
- **QR codes pour tables** individuelles avec param√®tres de table
- **QR code menu global** du restaurant
- **QR codes publics** accessibles sans authentification
- **G√©n√©ration en masse** pour toutes les tables d'un restaurant
- **R√©g√©n√©ration** de QR codes existants
- **Personnalisation** compl√®te (taille, couleurs, marges, correction d'erreur)
- **Statistiques** de couverture QR codes

### üìã **G√©n√©ration PDF**
- **Re√ßus automatiques** pour toutes les commandes livr√©es
- **Template HTML responsive** pour un rendu professionnel
- **Conversion HTML vers PDF** avec Puppeteer
- **Informations compl√®tes** (restaurant, commande, items, totaux)
- **Support logo restaurant** et personnalisation visuelle
- **Format ticket de caisse** optimis√© pour l'impression
- **Gestion multilingue** (fran√ßais par d√©faut)

### üóÇÔ∏è **Gestion Fichiers**
- **Service fichiers centralis√©** pour toutes les op√©rations
- **Gestion automatique** des dossiers (public/, uploads/)
- **Noms de fichiers uniques** avec timestamps et hash
- **Suppression s√©curis√©e** des fichiers
- **URLs publiques** pour acc√®s frontend
- **Nettoyage automatique** des fichiers anciens

---

## üèóÔ∏è Architecture

### **Structure des Modules**
```
src/files/
‚îú‚îÄ‚îÄ files.service.ts          # Service fichiers centralis√©
‚îú‚îÄ‚îÄ qr-code.controller.ts      # Endpoints QR codes
‚îú‚îÄ‚îÄ qr-code.service.ts         # Logique g√©n√©ration QR codes
‚îú‚îÄ‚îÄ pdf.controller.ts          # Endpoints PDF
‚îú‚îÄ‚îÄ pdf.service.ts             # Logique g√©n√©ration PDF
‚îî‚îÄ‚îÄ files.module.ts            # Module files complet

public/                        # Dossier fichiers publics
‚îú‚îÄ‚îÄ qr-codes/                  # QR codes g√©n√©r√©s
‚îî‚îÄ‚îÄ receipts/                  # Re√ßus PDF g√©n√©r√©s

uploads/                       # Dossier uploads temporaires
```

### **Flux QR Code**
```
1. Admin/Manager ‚Üí POST /qr-codes/table/:id
2. Service ‚Üí G√©n√©ration URL menu + param√®tres table
3. QRCode library ‚Üí Cr√©ation image PNG
4. FilesService ‚Üí Sauvegarde dans public/qr-codes/
5. Database ‚Üí Mise √† jour table.qr_code_url
6. Response ‚Üí URL publique pour t√©l√©chargement
```

### **Flux PDF Re√ßu**
```
1. Staff ‚Üí POST /pdf/receipt/order/:id
2. Service ‚Üí R√©cup√©ration donn√©es commande compl√®te
3. Template ‚Üí G√©n√©ration HTML responsive
4. Puppeteer ‚Üí Conversion HTML vers PDF
5. FilesService ‚Üí Sauvegarde dans public/receipts/
6. Response ‚Üí URL publique pour t√©l√©chargement
```

---

## üì± API Endpoints

### **QR Codes**

#### G√©n√©ration QR Code Table
```http
POST /api/v1/qr-codes/table/:tableId
Authorization: Bearer <jwt_token>
X-Tenant-Id: <tenant_id>

Query Parameters:
- size: 300 (taille en pixels)
- margin: 2 (marge)
- dark_color: #000000 (couleur sombre)
- light_color: #FFFFFF (couleur claire)

Response:
{
  "table_id": "uuid",
  "qr_code_url": "/public/qr-codes/qr_table_1_20240101_abc123.png",
  "public_url": "http://localhost:3001/public/qr-codes/qr_table_1_20240101_abc123.png"
}
```

#### G√©n√©ration QR Code Menu
```http
POST /api/v1/qr-codes/menu
Authorization: Bearer <jwt_token>
X-Tenant-Id: <tenant_id>

Response:
{
  "tenant_slug": "mon-restaurant",
  "qr_code_url": "/public/qr-codes/menu_mon-restaurant_20240101_def456.png",
  "public_url": "http://localhost:3001/public/qr-codes/menu_mon-restaurant_20240101_def456.png"
}
```

#### QR Code Public (sans auth)
```http
POST /api/v1/qr-codes/public/menu/:tenantSlug

Response:
{
  "tenant_slug": "mon-restaurant",
  "qr_code_url": "/public/qr-codes/menu_mon-restaurant_20240101_ghi789.png",
  "public_url": "http://localhost:3001/public/qr-codes/menu_mon-restaurant_20240101_ghi789.png"
}
```

#### G√©n√©ration Masse Tables
```http
POST /api/v1/qr-codes/tables/generate-all
Authorization: Bearer <jwt_token>

Response:
{
  "tenant_id": "uuid",
  "total_tables": 15,
  "results": [
    {
      "table": {
        "id": "uuid",
        "number": "1",
        "name": "Terrasse",
        "capacity": 4
      },
      "qr_url": "/public/qr-codes/qr_table_1_20240101_abc.png",
      "public_url": "http://localhost:3001/public/qr-codes/qr_table_1_20240101_abc.png"
    }
  ]
}
```

### **PDF Re√ßus**

#### G√©n√©ration Re√ßu Commande
```http
POST /api/v1/pdf/receipt/order/:orderId
Authorization: Bearer <jwt_token>
X-Tenant-Id: <tenant_id>

Response:
{
  "order_id": "uuid",
  "pdf_url": "/public/receipts/receipt_20240101001_20240101_xyz123.pdf",
  "public_url": "http://localhost:3001/public/receipts/receipt_20240101001_20240101_xyz123.pdf",
  "download_url": "/api/v1/pdf/download/receipt_20240101001_20240101_xyz123.pdf"
}
```

### **T√©l√©chargement & Visualisation**

#### T√©l√©charger QR Code
```http
GET /api/v1/qr-codes/download/:filename

Response: Binary PNG file
Headers:
- Content-Type: image/png
- Content-Disposition: attachment; filename="qr_code.png"
```

#### Visualiser PDF
```http
GET /api/v1/pdf/view/:filename

Response: Binary PDF file
Headers:
- Content-Type: application/pdf
- Content-Disposition: inline
```

---

## üé® Personnalisation

### **Options QR Code**
```typescript
interface QRCodeOptions {
  size?: number;              // 300px par d√©faut
  margin?: number;            // 2 par d√©faut
  color?: {
    dark?: string;            // #000000 par d√©faut
    light?: string;           // #FFFFFF par d√©faut
  };
  errorCorrectionLevel?: 'L' | 'M' | 'Q' | 'H'; // 'M' par d√©faut
}
```

### **Template Re√ßu PDF**
Le template HTML est enti√®rement personnalisable et inclut :
- **Header** avec logo restaurant et informations
- **Informations commande** (num√©ro, date, table, client)
- **Liste items** avec quantit√©s, prix unitaires et totaux
- **Total final** mis en √©vidence
- **Informations paiement** et statut
- **Notes commande** si pr√©sentes
- **Footer** avec date g√©n√©ration et remerciements

---

## üß™ Tests

### **Test Rapide (Compilation)**
```bash
node test-files-quick.js
```

### **Tests Manuels avec curl**

#### 1. G√©n√©rer QR Code pour table
```bash
curl -X POST "http://localhost:3000/api/v1/qr-codes/table/TABLE_ID?size=400&dark_color=%23333333" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "X-Tenant-Id: YOUR_TENANT_ID"
```

#### 2. G√©n√©rer QR Code menu public
```bash
curl -X POST "http://localhost:3000/api/v1/qr-codes/public/menu/mon-restaurant?size=500" \
  -H "Content-Type: application/json"
```

#### 3. G√©n√©rer re√ßu PDF
```bash
curl -X POST "http://localhost:3000/api/v1/pdf/receipt/order/ORDER_ID" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "X-Tenant-Id: YOUR_TENANT_ID"
```

#### 4. T√©l√©charger QR Code
```bash
curl -O "http://localhost:3000/api/v1/qr-codes/download/qr_table_1_20240101_abc123.png"
```

### **Test Int√©gration Frontend**
```html
<!DOCTYPE html>
<html>
<head>
    <title>Test QR Codes & PDF</title>
</head>
<body>
    <h1>Test Module Files</h1>
    
    <!-- Affichage QR Code -->
    <img src="http://localhost:3000/api/v1/qr-codes/view/qr_table_1_20240101_abc123.png" 
         alt="QR Code Table 1" 
         style="width: 200px;">
    
    <!-- Lien t√©l√©chargement PDF -->
    <a href="http://localhost:3000/api/v1/pdf/download/receipt_20240101001_20240101_xyz123.pdf" 
       target="_blank">
        T√©l√©charger Re√ßu PDF
    </a>
    
    <!-- Visualisation PDF -->
    <iframe src="http://localhost:3000/api/v1/pdf/view/receipt_20240101001_20240101_xyz123.pdf"
            width="100%" 
            height="600px">
    </iframe>
</body>
</html>
```

---

## üîß Configuration

### **Variables d'Environnement**
```env
# Frontend URL pour QR codes
FRONTEND_URL="http://localhost:3001"

# Configuration Puppeteer (optionnel)
PUPPETEER_EXECUTABLE_PATH="/usr/bin/chromium-browser"
PUPPETEER_ARGS="--no-sandbox,--disable-setuid-sandbox"
```

### **Permissions par R√¥le**
| Action | ADMIN | MANAGER | STAFF | Public |
|--------|-------|---------|-------|--------|
| G√©n√©rer QR table | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| G√©n√©rer QR menu | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| QR menu public | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| G√©n√©rer re√ßu PDF | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| Voir statistiques | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| T√©l√©charger fichiers | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |

---

## üöÄ Int√©grations

### **Avec le Module Tables**
- G√©n√©ration automatique QR codes lors cr√©ation tables
- Mise √† jour `table.qr_code_url` dans la base de donn√©es
- R√©g√©n√©ration QR codes lors modification tables

### **Avec le Module Orders**
- G√©n√©ration automatique re√ßus PDF apr√®s livraison
- Donn√©es compl√®tes commande + items + restaurant
- Int√©gration avec les statuts de commande

### **Avec le Module Menu**
- QR codes pointent vers menu public avec param√®tres table
- URLs dynamiques bas√©es sur `tenant.slug`
- Int√©gration avec le syst√®me de tables

---

## üìä Statistiques

### **QR Codes Stats**
```http
GET /api/v1/qr-codes/stats

Response:
{
  "totalTables": 15,
  "tablesWithQR": 12,
  "tablesWithoutQR": 3,
  "coveragePercentage": 80,
  "recentQRCodes": [...]
}
```

### **PDF Stats**
```http
GET /api/v1/pdf/stats

Response:
{
  "totalReceipts": 245,
  "recentReceipts": [...]
}
```

---

## üîí S√©curit√©

### **Validation Fichiers**
- Noms de fichiers valid√©s avec regex strict
- Pas d'acc√®s aux fichiers en dehors des dossiers autoris√©s
- Headers de s√©curit√© appropri√©s pour t√©l√©chargements

### **Gestion M√©moire**
- Puppeteer avec limite de m√©moire
- Nettoyage automatique des fichiers temporaires
- Fermeture propre des browsers Puppeteer

---

## üìà Performance

### **Optimisations QR Codes**
- G√©n√©ration en m√©moire sans fichiers temporaires
- Cache des QR codes g√©n√©r√©s
- Compression PNG optimis√©e

### **Optimisations PDF**
- Template HTML optimis√© pour Puppeteer
- R√©utilisation des instances browser quand possible
- Format PDF compress√© pour r√©duire la taille

---

## üìä M√©triques

**Module 5 - QR Code & PDF :** ‚úÖ **100% TERMIN√â**

- ‚úÖ 8 endpoints QR codes
- ‚úÖ 4 endpoints PDF
- ‚úÖ 3 services sp√©cialis√©s (Files, QR, PDF)
- ‚úÖ Support complet Puppeteer
- ‚úÖ Template HTML responsive
- ‚úÖ Personnalisation QR codes compl√®te
- ‚úÖ Gestion fichiers s√©curis√©e
- ‚úÖ Statistiques d√©taill√©es
- ‚úÖ Tests automatis√©s
- ‚úÖ Documentation compl√®te












